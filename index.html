<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>洗濯通知ステータス</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .status-area {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-item {
      margin-bottom: 10px;
    }
    .status-label {
      font-weight: bold;
      margin-right: 8px;
    }
    .edit-button {
      margin-left: 12px;
      padding: 4px 8px;
      font-size: 12px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .error-message {
      color: red;
      margin-top: 20px;
    }
    .debug-message {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
      white-space: pre-wrap;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4CAF50;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body>
  <h2>洗濯通知ステータス</h2>

  <div class="status-area" id="status-area">
    <div class="status-item">
      <span class="status-label">通知:</span><span id="status-notify">読み込み中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">曜日:</span><span id="status-days">読み込み中...</span>
      <button class="edit-button" onclick="openEditModal()">編集</button>
    </div>
    <div class="status-item">
      <span class="status-label">時刻:</span><span id="status-time">読み込み中...</span>
    </div>
    <div class="status-item">
      <span class="status-label">郵便番号:</span><span id="status-zipcode">読み込み中...</span>
      <button class="edit-button" onclick="openEditModal()">編集</button>
    </div>
    <div class="status-item">
      <span class="status-label">全体通知:</span>
      <label class="switch">
        <input type="checkbox" id="master-toggle" onchange="handleMasterToggle()" />
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <div class="error-message" id="error-message"></div>
  <div class="debug-message" id="debug-message"></div>

  <!-- 🔧 モーダル -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <h3>通知設定の編集</h3>
      <label>郵便番号：<input type="text" id="edit-zipcode" /></label>
      <div>
        <label><input type="checkbox" value="月" /> 月</label>
        <label><input type="checkbox" value="火" /> 火</label>
        <label><input type="checkbox" value="水" /> 水</label><br />
        <label><input type="checkbox" value="木" /> 木</label>
        <label><input type="checkbox" value="金" /> 金</label>
        <label><input type="checkbox" value="土" /> 土</label>
        <label><input type="checkbox" value="日" /> 日</label>
      </div>
      <div class="modal-actions">
        <button onclick="saveEdit()">保存</button>
        <button onclick="closeEditModal()">キャンセル</button>
      </div>
    </div>
  </div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const liffId = "2007511869-DXmQ2r0r";
  const GAS_BASE_URL = "https://cors-proxy.ogisho-other.workers.dev";
  let currentUserId = "";

  async function loadStatus() {
    const debugEl = document.getElementById("debug-message");
    const errorEl = document.getElementById("error-message");

    try {
      await liff.init({ liffId });

      if (!liff.isLoggedIn()) {
        debugEl.textContent = "🔴 LIFF未ログイン → login処理へ";
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const userId = profile.userId;
      currentUserId = userId;
      debugEl.textContent = `🟢 userId取得成功: ${userId}\n`;

      const res = await fetch(GAS_BASE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId })
      });

      const text = await res.text();
      debugEl.textContent += `📥 レスポンス: ${text}\n`;

      const json = JSON.parse(text);
      if (!json.success) throw new Error(json.message);

      const data = json.data;
      document.getElementById("status-notify").textContent = data.notify || "未設定";
      document.getElementById("status-days").textContent = data.days || "未設定";
      document.getElementById("status-time").textContent = data.time || "未設定";
      document.getElementById("status-zipcode").textContent = data.zipcode || "未設定";
      document.getElementById("master-toggle").checked = (data.notify === "ON");

    } catch (e) {
      errorEl.textContent = "エラー: " + e.message;
      debugEl.textContent += `⚠️ ${e.message}`;
    }
  }

  function openEditModal() {
    document.getElementById("edit-modal").style.display = "flex";
  }

  function closeEditModal() {
    document.getElementById("edit-modal").style.display = "none";
  }

  function saveEdit() {
    const zip = document.getElementById("edit-zipcode").value.trim();
    const dayChecks = Array.from(document.querySelectorAll('#edit-modal input[type="checkbox"]:checked'));
    const days = dayChecks.map(c => c.value).join(",");

    fetch(GAS_BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUserId,
        zipcode: zip,
        days: days
      })
    }).then(() => {
      closeEditModal();
      location.reload();
    });
  }

  function handleMasterToggle() {
    const isOn = document.getElementById("master-toggle").checked;
    fetch(GAS_BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: currentUserId,
        notify: isOn ? "ON" : "OFF"
      })
    });
  }

  window.onload = loadStatus;
</script>
</body>
</html>
