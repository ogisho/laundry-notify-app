<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>通知設定ステータス</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
    h1 { font-size: 24px; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 16px; margin: 12px 0; }
    .setting-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; }
    .edit-btn { background-color: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    .edit-btn:hover { background-color: #0056b3; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 10px; }
    .modal-actions { display: flex; justify-content: space-between; margin-top: 16px; }
    .status-block { margin-left: 16px; font-size: 14px; color: #555; }
    select, input[type="text"] { width: 100%; margin: 5px 0; padding: 4px; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let userId = null;
    const GAS_DEPLOYED_URL = "https://script.google.com/macros/s/YOUR_DEPLOYED_URL/exec";

    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      userId = params.get('userId');
      console.log('取得したuserId:', userId);
    });

    function openModal(type) {
      document.getElementById(`modal-${type}`).style.display = 'block';
    }
    function closeModal(type) {
      document.getElementById(`modal-${type}`).style.display = 'none';
    }

    function saveSettings() {
      const toggle = document.getElementById('laundry-toggle-select').value;
      const hour = document.getElementById('hour-select').value;
      const minute = document.getElementById('minute-select').value;
      const zip = document.getElementById('zip-code').value;
      const days = [...document.querySelectorAll('#modal-laundry input[type="checkbox"]:checked')].map(cb => cb.value);

      if (!/^[0-9]{7}$/.test(zip)) {
        alert("郵便番号は7桁の数字で入力してください");
        return;
      }

      document.getElementById('laundry-toggle').innerText = toggle;
      document.getElementById('laundry-time-status').innerText = `${hour}:${minute}`;
      document.getElementById('laundry-days-status').innerText = days.join('') || '未登録';
      document.getElementById('laundry-zip-status').innerText = zip;

      // GASに送信
      const payload = {
        userId: userId,
        laundry: {
          on: toggle === "ON",
          hour: hour,
          minute: minute,
          days: days,
          zip: zip
        }
      };

      fetch(GAS_DEPLOYED_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "保存しました");
        closeModal('laundry');
      })
      .catch(error => {
        console.error("送信失敗:", error);
        alert("保存に失敗しました");
      });
    }

    window.onload = () => {
      const hourSelect = document.getElementById('hour-select');
      const minuteSelect = document.getElementById('minute-select');
      for (let h = 0; h <= 23; h++) {
        hourSelect.innerHTML += `<option value="${h.toString().padStart(2, '0')}">${h.toString().padStart(2, '0')}</option>`;
      }
      for (let m = 0; m <= 55; m += 5) {
        minuteSelect.innerHTML += `<option value="${m.toString().padStart(2, '0')}">${m.toString().padStart(2, '0')}</option>`;
      }
    };
  </script>
</head>
<body>
<h1>現在の通知設定</h1>
<div class="card">
  <div class="setting-row">
    <div>
      🧺洗濯指数（<span id="laundry-toggle">OFF</span>）
      <div class="status-block">
        ・通知時間：<span id="laundry-time-status">未登録</span><br/>
        ・通知曜日：<span id="laundry-days-status">未登録</span><br/>
        ・郵便番号：<span id="laundry-zip-status">未登録</span>
      </div>
    </div>
    <button class="edit-btn" onclick="openModal('laundry')">編集</button>
  </div>
</div>

<!-- モーダル -->
<div class="modal" id="modal-laundry">
  <div class="modal-content">
    <h2>洗濯指数の編集</h2>
    <label>通知ON/OFF：</label>
    <select id="laundry-toggle-select">
      <option value="ON">ON</option>
      <option value="OFF">OFF</option>
    </select><br/>
    <label>通知時間：</label>
    <div style="display: flex; gap: 5px;">
      <select id="hour-select"></select>
      <select id="minute-select"></select>
    </div><br/>
    <label>通知曜日：</label><br/>
    <label><input type="checkbox" value="月"/> 月</label>
    <label><input type="checkbox" value="火"/> 火</label>
    <label><input type="checkbox" value="水"/> 水</label>
    <label><input type="checkbox" value="木"/> 木</label>
    <label><input type="checkbox" value="金"/> 金</label>
    <label><input type="checkbox" value="土"/> 土</label>
    <label><input type="checkbox" value="日"/> 日</label>
    <label><input type="checkbox" value="祝"/> 祝</label><br/><br/>
    <label>郵便番号（7桁、数字のみ）：</label>
    <input id="zip-code" maxlength="7" placeholder="例：1234567" type="text"/>
    <div class="modal-actions">
      <button onclick="saveSettings()">保存</button>
      <button onclick="closeModal('laundry')">キャンセル</button>
    </div>
  </div>
</div>
</body>
</html>
