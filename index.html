<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- 略 -->
</head>
<body>
  <!-- HTMLそのまま、変更なし -->

  <script>
  const PROXY_PREFIX = "https://cors-proxy.ogisho-other.workers.dev/";
  const GAS_DEPLOY_URL = "https://script.google.com/macros/s/AKfycbwnorPK5XIKdz1PyzVHcax82Q9bfgE44eYbCBhJO1aiVPVxnhmoAW8OirTGnhwtB979kw/exec";
  const GAS_URL = PROXY_PREFIX + GAS_DEPLOY_URL;
  const LIFF_ID = "2007511869-DXmQ2r0r";
  let userId = "";
  let currentData = {}; // 追加

  async function initializeLiff() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    fetchSettings();
  }

  function openModal(type) {
    document.getElementById(`modal-${type}`).style.display = "flex";
  }

  function closeModal(type) {
    document.getElementById(`modal-${type}`).style.display = "none";
  }

  function populateTimeSelectors() {
    const hourSelect = document.getElementById("hourSelect");
    const minuteSelect = document.getElementById("minuteSelect");
    for (let h = 0; h < 24; h++) {
      hourSelect.innerHTML += `<option value="${h.toString().padStart(2, '0')}">${h.toString().padStart(2, '0')}</option>`;
    }
    for (let m = 0; m < 60; m += 5) {
      minuteSelect.innerHTML += `<option value="${m.toString().padStart(2, '0')}">${m.toString().padStart(2, '0')}</option>`;
    }
  }

  function updateView() {
    document.getElementById("toggleNotify").checked = currentData.notify === "on";
    document.getElementById("statusText").innerText = currentData.notify === "on" ? "ON" : "OFF";
    document.getElementById("notifyTime").innerText = currentData.time || "--:--";
    document.getElementById("notifyDays").innerText = currentData.days || "--";
    document.getElementById("zipcode").innerText = currentData.zipcode || "--";
  }

  async function fetchSettings() {
    try {
      const res = await fetch(`${GAS_URL}?userId=${userId}`);
      const json = await res.json();
      if (!json.success || !json.data) return;

      currentData = {
        notify: json.data.notify ?? "",
        time: json.data.time ?? "",
        days: json.data.days ?? "",
        zipcode: json.data.zipcode ?? ""
      };
      updateView();

      const [h, m] = (currentData.time || "00:00").split(":");
      document.getElementById("hourSelect").value = h;
      document.getElementById("minuteSelect").value = m;
      document.getElementById("modalToggle").checked = currentData.notify === "on";
      document.getElementById("zipcodeInput").value = currentData.zipcode || "";

      document.querySelectorAll(".checkbox-group input[type=checkbox]").forEach(cb => {
        cb.checked = currentData.days.includes(cb.value);
      });
    } catch (e) {
      console.error("設定取得エラー:", e);
    }
  }

  async function saveNotifySettings() {
    const notifyEnabled = document.getElementById("modalToggle").checked ? "on" : "off";
    const hour = document.getElementById("hourSelect").value;
    const minute = document.getElementById("minuteSelect").value;
    const notifyTime = `${hour}:${minute}`;

    const body = { userId, notifyEnabled, notifyTime };
    try {
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const result = await res.json();
      if (!result.success) return alert("保存に失敗しました");

      currentData.notify = notifyEnabled;
      currentData.time = notifyTime;
      updateView();
      closeModal("notify");
    } catch (e) {
      console.error("保存エラー:", e);
      alert("保存時にエラーが発生しました");
    }
  }

  async function saveLaundrySettings() {
    const zipcode = document.getElementById("zipcodeInput").value;
    if (!/^\d{7}$/.test(zipcode)) {
      document.getElementById("zipcodeError").style.display = "block";
      return;
    }
    document.getElementById("zipcodeError").style.display = "none";

    const notifyDays = Array.from(document.querySelectorAll(".checkbox-group input[type=checkbox]:checked"))
      .map(cb => cb.value).join(",");

    const body = { userId, zipcode, notifyDays };
    try {
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const result = await res.json();
      if (!result.success) return alert("保存に失敗しました");

      currentData.zipcode = zipcode;
      currentData.days = notifyDays;
      updateView();
      closeModal("laundry");
    } catch (e) {
      console.error("保存エラー:", e);
      alert("保存時にエラーが発生しました");
    }
  }

  window.onload = () => {
    populateTimeSelectors();
    initializeLiff();
  };
  </script>
</body>
</html>
